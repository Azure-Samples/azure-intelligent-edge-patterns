# Sample clients

Azure Machine Learning Hardware Accelerated Models implements part of the [Tensorflow Serving Predict API](https://github.com/tensorflow/serving/blob/r1.12/tensorflow_serving/apis/prediction_service.proto), which uses gRPC, an HTTP/2 RPC protocol. Specifically, we only support the `Predict` RPC call.  

## Provided clients
We provide sample clients for CSharp and Python. These clients are built on top of the code generated by the gRPC codegen tools.

### Using provided clients
For optimal performance, you should reuse the client object between calls.
#### C#
See `csharp\resnet` for a sample console application that uses the provided C# client.
#### Python
A python client is included in the [Azure-ML SDK](https://docs.microsoft.com/en-us/python/api/azureml-accel-models/azureml.accel.predictionclient?view=azure-ml-py).

## Generated Clients
You can also generate clients for your prefered language by using the gRPC codegen tools. For more information - especially on using the generated clients - consult the [gRPC documentation.](https://grpc.io/docs/)

### Generating clients for other languages
#### Requirements
1. gRPC and its prerequesites for your desired language. To install these, follow the [quickstart instructions](https://grpc.io/docs/) for the desired language.
#### Instructions
1. Run protoc with the grpc plugin to generate code for the desired language. Consult the GRPC docs for instructions on how to install and locate protoc and the grpc plugin.

This example is for Golang
```
sample-clients>protoc.exe -I protos/ tensorflow/core/framework/tensor.proto tensorflow/core/framework/types.proto tensorflow/core/framework/resource_handle.proto tensorflow/core/framework/tensor_shape.proto --go_out=plugins=grpc:go
sample-clients>protoc.exe -I protos tensorflow_serving/apis/predict.proto tensorflow_serving/apis/model.proto tensorflow_serving/apis/prediction_service.proto --go_out=plugins=grpc:go
```

This will generate the go source code in `sample-clients\go`
### Using generated clients
Using the generated clients is going to vary based on language, however the basic flow is:
1. Create a connection with the remote server
2. Create a prediction client with this connection
3. Add the appropriate Metadata for the call. You will need to add one or two pairs of metadata, `("x-ms-aml-grpc-service-route", "/api/v1/service/{serviceName}")` and if the service has authorization enabled, `("authorization", "bearer {key}")`.
3. Construct the tensor(s) for input
4. Construct the predict request from the tensors
5. Make an RPC call with the request using the client
6. Read the response and consume it

For an example of building on the generated code, look in `csharp/client`
