param
(
    $iSCSITargetName = "ISCSITarget01",
    $FolderShare = 'C:\iscsishare',
    $ShareDisk =  'Disk01.vhdx'
)


Join-Path $FolderShare $ShareDisk

install-windowsfeature FS-iSCSITarget-server -IncludeManagementTools

$IPTargets = @(Get-NetIPAddress | ? {$_.ipaddress -ne '127.0.0.1' -and $_.AddressFamily -eq 'IPv4' } | Select IPAddress).IPAddress | % {"IPAddress:" + $_} 

new-iscsiservertarget -targetname $iSCSITargetName  -InitiatorIds $IPTargets 
New-IscsiVirtualDisk -Path "C:\iscsishare\Disk01.vhdx" -SizeBytes 10GB 
Add-IscsiVirtualDiskTargetMapping -TargetName $iSCSITargetName  -Path "C:\iscsishare\Disk01.vhdx" 
Set-IscsiServerTarget -TargetName $iSCSITargetName -EnableChap $True -Chap (New-Object PSCredential("username", (ConvertTo-SecureString -AsPlainText "UserP@ssw0rd01" -Force))) -PassThru 


Get-IscsiServerTarget -TargetName $iSCSITargetName
Restart-Service -Name WinTarget 